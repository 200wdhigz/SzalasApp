name: update-wiki

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: update-wiki-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-wiki:
    name: update-wiki
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare wiki files
        shell: bash
        run: |
          set -euo pipefail

          REPO_URL="https://github.com/${GITHUB_REPOSITORY}"
          SRC_DIR="wiki/docs"
          OUT_DIR="wiki/export"

          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"

          # Mapping: docs file -> wiki export filename
          # Format: src|dest
          mapfile -t MAP <<'EOF'
          00_INDEX.md|Home.md
          README.md|Documentation-Index.md
          01_QUICK_START.md|Quick-Start.md
          02_ARCHITECTURE.md|Architecture.md
          03_OAUTH_SETUP.md|OAuth-Setup.md
          04_ACCOUNT_MANAGEMENT.md|Account-Management.md
          05_USER_SYNC.md|User-Synchronization.md
          06_EQUIPMENT_MANAGEMENT.md|Equipment-Management.md
          07_MALFUNCTION_SYSTEM.md|Malfunction-System.md
          08_DATA_EXPORT.md|Data-Export.md
          09_ADMIN_PANEL.md|Admin-Panel.md
          10_SECURITY.md|Security.md
          11_BACKUP_RESTORE.md|Backup-and-Restore.md
          12_INSTALLATION.md|Installation.md
          13_DOCKER.md|Docker-Deployment.md
          14_MONITORING.md|Monitoring-and-Logs.md
          15_RECAPTCHA.md|ReCAPTCHA.md
          16_FIREBASE.md|Firebase-Configuration.md
          17_EMAIL_SMTP.md|Email-SMTP.md
          18_CHANGELOG.md|Changelog.md
          19_FAQ.md|FAQ.md
          20_TROUBLESHOOTING.md|Troubleshooting.md
          21_DEVELOPMENT.md|Development.md
          22_TESTING.md|Testing.md
          23_CONTRIBUTING.md|Contributing.md
          24_DEPENDENCIES.md|Dependencies-Guide.md
          25_FEATURE_SUMMARY.md|Feature-Summary.md
          26_DEPLOYMENT_PRODUCTION.md|Deployment-Production.md
          NPM_INDEX.md|NPM-Deployment-Index.md
          EOF

          # Build sed script for internal wiki links: [text](docs/FILE.md) -> [text](Wiki-Name)
          # Also handles ../docs/FILE.md and ./FILE.md
          sed_script=""
          for pair in "${MAP[@]}"; do
            src="${pair%%|*}"
            dst="${pair#*|}"
            wiki_name="${dst%.md}"

            # escape regex metacharacters
            src_re=$(printf '%s' "$src" | sed 's/[.[\\*^$+?{}|()]/\\&/g')

            # docs/FILE.md
            sed_script+="s#\\]\\((docs/)?${src_re}([#)])#](${wiki_name}\\2#g;"
            # ../docs/FILE.md
            sed_script+="s#\\]\\(\\.\\./docs/${src_re}([#)])#](${wiki_name}\\1#g;"
            # ./FILE.md
            sed_script+="s#\\]\\(\\./${src_re}([#)])#](${wiki_name}\\1#g;"
          done

          # Convert ../../ links to GitHub blob links
          # [text](../../PATH) -> [text](https://github.com/<repo>/blob/main/PATH)
          sed_script+="s#\\]\\(\\.\\.\\/\\.\\.\\/([^#)]+)#](${REPO_URL}/blob/main/\\1#g;"

          # Process each file
          for pair in "${MAP[@]}"; do
            src="${pair%%|*}"
            dst="${pair#*|}"

            in_path="${SRC_DIR}/${src}"
            out_path="${OUT_DIR}/${dst}"

            if [ ! -f "$in_path" ]; then
              echo "Skipping missing: $in_path"
              continue
            fi

            # Apply link conversion
            sed -E "$sed_script" "$in_path" > "$out_path"
            echo "âœ… ${src} -> ${dst}"
          done

          # Sidebar / Footer
          cat > "${OUT_DIR}/_Sidebar.md" <<EOF
          ## ðŸ“š SzalasApp Wiki

          ### ðŸš€ Start
          * [Strona GÅ‚Ã³wna](Home)
          * [Szybki Start](Quick-Start)
          * [FAQ](FAQ)

          ### ðŸ“– Podstawy
          * [Architektura](Architecture)
          * [OAuth Setup](OAuth-Setup)
          * [ZarzÄ…dzanie Kontami](Account-Management)
          * [Synchronizacja UÅ¼ytkownikÃ³w](User-Synchronization)

          ### ðŸ”§ Funkcje Systemu
          * [ZarzÄ…dzanie SprzÄ™tem](Equipment-Management)
          * [System Usterek](Malfunction-System)
          * [Eksport Danych](Data-Export)

          ### ðŸ‘¨â€ðŸ’¼ Administracja
          * [Panel Administratora](Admin-Panel)
          * [BezpieczeÅ„stwo](Security)
          * [Backup i Restore](Backup-and-Restore)

          ### ðŸš€ Deployment
          * [Instalacja](Installation)
          * [Docker](Docker-Deployment)
          * [Deployment Produkcyjny](Deployment-Production)
          * [NPM Deployment](NPM-Deployment-Index) â­
          * [Monitoring](Monitoring-and-Logs)

          ### ðŸ”Œ Integracje
          * [Firebase](Firebase-Configuration)
          * [reCAPTCHA](ReCAPTCHA)
          * [Email SMTP](Email-SMTP)

          ### ðŸ’» Dla DeweloperÃ³w
          * [Development](Development)
          * [Testing](Testing)
          * [Contributing](Contributing)
          * [Dependencies](Dependencies-Guide)

          ### ðŸ“ Inne
          * [Index Dokumentacji](Documentation-Index)
          * [Changelog](Changelog)
          * [Troubleshooting](Troubleshooting)
          * [Feature Summary](Feature-Summary)

          ---

          [Repo](${REPO_URL})
          EOF

          cat > "${OUT_DIR}/_Footer.md" <<EOF
          ---
          SzalasApp | [Repo](${REPO_URL}) | [ZgÅ‚oÅ› problem](${REPO_URL}/issues) | [Wiki Home](Home)
          EOF

          echo "Prepared wiki export in ${OUT_DIR}"

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy files to wiki
        shell: bash
        run: |
          set -euo pipefail
          find wiki-repo -maxdepth 1 -type f -name "*.md" -delete
          cp wiki/export/*.md wiki-repo/

      - name: Commit and push changes
        working-directory: wiki-repo
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Auto-update wiki from repo (${GITHUB_SHA})"
          git push
