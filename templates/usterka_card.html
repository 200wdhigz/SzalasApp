{% extends 'base.html' %}

{% block content %}
<style>
  #usterkaCarousel .carousel-inner { aspect-ratio: 4 / 3; overflow: hidden; }
  #usterkaCarousel .carousel-item img { width:100%; height:100%; object-fit:cover; }
  #imageModal .modal-dialog { max-width:95vw; max-height:95vh; }
  #imageModal .modal-body img { max-height:85vh; width:auto; }
  .thumb { width:100px; height:65px; object-fit:cover; cursor:pointer; }
</style>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-warning text-dark">
      <h4 class="mb-0">Zgłoszona Usterka: <span class="badge bg-light text-dark">{{ usterka.sprzet_id | upper }}</span></h4>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-5">
          <div id="usterkaCarousel" class="carousel slide mb-2" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% if usterka.zdjecia_lista_url %}
                {% for url in usterka.zdjecia_lista_url %}
                  <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-img-url="{{ url }}">
                      <img src="{{ url }}" class="d-block w-100" alt="Zdjęcie {{ loop.index }}">
                    </a>
                  </div>
                {% endfor %}
              {% else %}
                <div class="carousel-item active">
                  <img src="{{ url_for('static', filename='img/placeholder.png') }}" class="d-block w-100" alt="Brak zdjęcia">
                </div>
              {% endif %}
            </div>

            {% if usterka.zdjecia_lista_url | length > 1 %}
              <button class="carousel-control-prev" type="button" data-bs-target="#usterkaCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Poprzednie</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#usterkaCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Następne</span>
              </button>
            {% endif %}
          </div>

          <div class="d-flex overflow-auto">
            {% for url in usterka.zdjecia_lista_url %}
              <img src="{{ url }}" class="img-thumbnail me-1 thumb {% if loop.first %}border-primary{% endif %}" alt="Miniatura {{ loop.index }}"
                   onclick="document.querySelectorAll('#usterkaCarousel .carousel-item').forEach(i=>i.classList.remove('active')); document.querySelectorAll('#usterkaCarousel .carousel-item')[{{ loop.index0 }}].classList.add('active'); this.closest('.d-flex').querySelectorAll('.img-thumbnail').forEach(t=>t.classList.remove('border-primary')); this.classList.add('border-primary');">
            {% endfor %}
          </div>
        </div>

        <div class="col-md-7">
          <h5 class="text-primary">Szczegóły Zgłoszenia</h5>
          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item"><strong>Opis:</strong> {{ usterka.opis }}</li>
            <li class="list-group-item"><strong>Zgłoszono przez:</strong> {{ usterka.zgloszono_przez | default('Anonim') }}</li>
            <li class="list-group-item"><strong>Data zgłoszenia:</strong> {{ usterka.data_zgloszenia }}</li>
            <li class="list-group-item">
              <strong>Status:</strong>
              <span class="badge
                {% if usterka.status == 'oczekuje' %} bg-warning text-dark
                {% elif usterka.status == 'w trakcie' %} bg-info text-dark
                {% elif usterka.status == 'naprawiona' %} bg-success
                {% elif usterka.status == 'odrzucona' %} bg-danger
                {% else %} bg-secondary
                {% endif %}">{{ usterka.status | capitalize }}</span>
            </li>
            <li class="list-group-item"><strong>Powiązany sprzęt:</strong> {{ usterka.sprzet_id | upper }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal lightbox -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-header border-0 p-0">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 text-center">
        <div id="modalCarousel" class="carousel slide" data-bs-interval="false">
          <div class="carousel-inner">
            {% if usterka.zdjecia_lista_url %}
              {% for url in usterka.zdjecia_lista_url %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                  <img src="{{ url }}" class="img-fluid" alt="Powiększone {{ loop.index }}">
                </div>
              {% endfor %}
            {% else %}
              <div class="carousel-item active">
                <img src="{{ url_for('static', filename='img/placeholder.png') }}" class="img-fluid" alt="Brak zdjęcia">
              </div>
            {% endif %}
          </div>

          {% if usterka.zdjecia_lista_url | length > 1 %}
            <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Poprzednie</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Następne</span>
            </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var modal = document.getElementById('imageModal');
  var modalCarousel = document.getElementById('modalCarousel');

  if (modal) {
    modal.addEventListener('show.bs.modal', function(e){
      var trigger = e.relatedTarget;
      var url = trigger ? trigger.getAttribute('data-img-url') : null;
      if (!modalCarousel) return;
      var items = modalCarousel.querySelectorAll('.carousel-item');
      items.forEach(i=>i.classList.remove('active'));
      if (url) {
        for (let i=0;i<items.length;i++){
          if (items[i].querySelector('img').src === url) { items[i].classList.add('active'); break; }
        }
      }
      // init carousel instance if bootstrap available
      if (typeof bootstrap !== 'undefined' && bootstrap.Carousel) {
        new bootstrap.Carousel(modalCarousel, { interval:false, ride:false });
      }
    });
  }
});
</script>
{% endblock %}
