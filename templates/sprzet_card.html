{% extends 'base.html' %}

{% block content %}
<style>
    /* Wymuszanie proporcji 16:9 dla kontenera karuzeli */
    #sprzetCarousel .carousel-inner {
        aspect-ratio: 4 / 3;
        overflow: hidden;
    }
    /* Zapewnienie, 偶e zdjcia wypeni kontener 16:9 */
    #sprzetCarousel .carousel-item img {
        width: 100%;
        height: 100%;
        /* U偶ycie object-fit: cover gwarantuje, 偶e obraz wypeni 16:9, przycinajc pionowe (9:16) */
        object-fit: cover;
    }

    #imageModal .modal-dialog {
        max-width: 95vw; /* Ogranicz maksymaln szeroko do 95% widocznej czci ekranu */
        max-height: 95vh; /* Ogranicz maksymaln wysoko do 95% widocznej czci ekranu */
    }

    #imageModal .modal-body {
        max-height: 90vh; /* Maksymalna wysoko dla zawartoci body modala */
        overflow-y: auto; /* W razie potrzeby dodaje przewijanie */
    }

    #imageModal .modal-body img {
        /* Upewnia si, 偶e obraz nie wyjdzie poza wysoko Modala, zachowujc proporcje */
        max-height: 85vh;
        width: auto; /* Pozwala na swobodne dostosowanie szerokoci, zachowujc oryginalne proporcje */
    }
</style>


<div class="container mt-5">
    <h2 class="mb-4">Karta Sprztu: <span class="badge text-bg-primary">{{ sprzet.id | upper }}</span> - {{ sprzet.typ | upper }}</h2>

    <div class="row">

        <div class="col-lg-5">

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-center">Galeria Zdj</h5>
                </div>

                <div id="sprzetCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% if sprzet.zdjecia_lista_url %}
                            {% for url in sprzet.zdjecia_lista_url %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-img-url="{{ url }}">
                                        <img src="{{ url }}" class="d-block w-100" alt="Zdjcie {{ loop.index }}">
                                    </a>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="carousel-item active">
                                <img src="{{ url_for('static', filename='img/placeholder.png') }}" class="d-block w-100" alt="Brak zdjcia">
                            </div>
                        {% endif %}
                    </div>

                    {% if sprzet.zdjecia_lista_url | length > 1 %}

                    <button class="carousel-control-prev" type="button" data-bs-target="#sprzetCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Poprzednie</span>
                    </button>

                    <button class="carousel-control-next" type="button" data-bs-target="#sprzetCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Nastpne</span>
                    </button>

                    {% endif %}
                </div>

                <div class="card-footer p-2">
                    <div class="d-flex overflow-auto">
                        {% for url in sprzet.zdjecia_lista_url %}
                            <img src="{{ url }}"
                                 class="img-thumbnail me-1 {% if loop.first %}border-primary{% endif %}"
                                 style="width: 100px; height: 65px; object-fit: cover; cursor: pointer;"
                                 alt="Miniatura {{ loop.index }}"
                                 onclick="document.getElementById('sprzetCarousel').querySelector('.carousel-item.active').classList.remove('active');
                                          document.getElementById('sprzetCarousel').querySelectorAll('.carousel-item')[{{ loop.index0 }}].classList.add('active');
                                          this.closest('.card-footer').querySelectorAll('.img-thumbnail').forEach(el => el.classList.remove('border-primary'));
                                          this.classList.add('border-primary');"
                            >
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">Zgo Now Usterk dla {{ sprzet.id | upper }}</h4>
                </div>
                <div class="card-body">
                    <form method="POST" onsubmit="return submitFormWithRecaptcha(this, 'submit_defect');">

                        <input type="hidden" name="sprzet_id" value="{{ sprzet.id }}">

                        <div class="mb-3">
                            <label for="opis_usterki" class="form-label">Opis Usterki (obowizkowo)</label>
                            <textarea
                                class="form-control"
                                id="opis_usterki"
                                name="opis_usterki"
                                rows="3"
                                required
                                placeholder="Opisz dokadnie, co jest nie tak (np. 'Urwana szlufka przy wejciu', 'Brakuje 3 ledzi', 'Cieknie w rogu')."
                            ></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="zgloszono_przez" class="form-label">Zgoszono przez (opcjonalnie)</label>
                            <input
                                type="text"
                                class="form-control"
                                id="zgloszono_przez"
                                name="zgloszono_przez"
                                placeholder="Wpisz swoje imi lub pseudonim."
                            >
                        </div>

                        <p class="text-muted small">
                            <i class="bi bi-shield-lock-fill"></i> Ta operacja jest chroniona przez reCAPTCHA Enterprise.
                        </p>

                        <button type="submit" class="btn btn-danger">
                            Zgo Usterk
                        </button>
                    </form>
                </div>
            </div>

             {% if is_admin %}
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Panel Admina: Dodaj Zdjcie </h4>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('upload_photo') }}" method="POST" enctype="multipart/form-data">

                        <input type="hidden" name="sprzet_id" value="{{ sprzet.id }}">

                        <div class="mb-3">
                            <label for="photo_file" class="form-label">Wybierz plik(i) do wgrania (Max 5MB)</label>
                            <input
                                class="form-control"
                                type="file"
                                id="photo_file"
                                name="photo_file"
                                accept="image/*"
                                multiple
                                required
                            >
                            <div class="form-text">
                                Mo偶esz wybra kilka plik贸w jednoczenie.
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            Wgraj Zdjcie(a)
                        </button>
                    </form>
                    </div>
            </div>
            {% endif %}

        </div>
        <div class="col-lg-7">

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Dane Techniczne i Historia</h4>
                </div>
                <div class="card-body">
                    <div class="row">

                        <div class="col-md-4">
                            <h5 class="mt-2 text-primary">Informacje Podstawowe</h5>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item"><strong>ID Sprztu:</strong> {{ sprzet.id | upper }}</li>
                                <li class="list-group-item"><strong>Typ Sprztu:</strong> {{ sprzet.typ }}</li>
                                <li class="list-group-item">
                                    <strong>Stan Og贸lny:</strong>
                                    <span class="badge
                                        {% if sprzet.stan_ogolny == 'bardzo dobry' %} bg-success
                                        {% elif sprzet.stan_ogolny == 'dobry' %} bg-primary
                                        {% elif sprzet.stan_ogolny == 'redni' %} bg-info text-dark
                                        {% elif sprzet.stan_ogolny == 'DO KONSERWACJI' %} bg-warning text-dark
                                        {% else %} bg-secondary
                                        {% endif %}
                                        ">
                                        {{ sprzet.stan_ogolny }}
                                    </span>
                                </li>
                                <li class="list-group-item"><strong>Obecna Lokalizacja:</strong> {{ sprzet.lokalizacja }}</li>
                                <li class="list-group-item"><strong>Przeznaczenie:</strong> {{ sprzet.przeznaczenie }}</li>
                            </ul>
                        </div>

                        <div class="col-md-4">
                            <h5 class="mt-2 text-primary">Szczeg贸y Techniczne</h5>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item"><strong>Wodoszczelno:</strong> {{ sprzet.wodoszczelnosc }}</li>
                                <li class="list-group-item"><strong>Kolor Dachu:</strong> {{ sprzet.kolor_dachu | capitalize }}</li>
                                <li class="list-group-item"><strong>Kolor Bok贸w:</strong> {{ sprzet.kolor_bokow | capitalize }}</li>
                                <li class="list-group-item"><strong>Znak Szczeg贸lny:</strong> {{ sprzet.znak_szczegolny }}</li>
                                <li class="list-group-item"><strong>Ilo Zapaek:</strong> {{ sprzet.zapalki }}</li>
                            </ul>
                        </div>

                        <div class="col-md-4">
                            <h5 class="mt-2 text-primary">Historia i Konserwacja</h5>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item"><strong>Zakup:</strong> {{ sprzet.zakup }}</li>
                                <li class="list-group-item"><strong>Przejty:</strong> {{ sprzet.przejecie }}</li>
                                <li class="list-group-item"><strong>Wymaga Powrotu:</strong> {{ sprzet.czyWraca | default('Nie', true) }}</li>
                                <li class="list-group-item">
                                    <strong>Historia/Opis:</strong>
                                    <small class="text-muted">{{ sprzet.historia | default('Brak opisu.', true) | truncate(50, True) }}</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>Uwagi Konserwacyjne:</strong>
                                    <small class="text-muted">{{ sprzet.uwagi | default('Brak uwag.', true) | truncate(50, True) }}</small>
                                </li>
                            </ul>
                        </div>
                    </div>

                    {% if sprzet.historia | length > 50 or sprzet.uwagi | length > 50 %}
                        <div class="alert alert-light mt-3">
                            <small><strong>Peny Opis Historii:</strong> {{ sprzet.historia }}</small><br>
                            <small><strong>Pene Uwagi Konserwacyjne:</strong> {{ sprzet.uwagi }}</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">Zgoszone Usterki ({{ usterki | length }})</h4>
                </div>
                <div class="card-body">
                    {% if usterki %}
                    <ul class="list-group">
                        {% for usterka in usterki %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ usterka.opis | truncate(100, True) }}</strong><br>
                                    <small class="text-muted">
                                        Zgoszono przez: {{ usterka.zgloszono_przez }}
                                        (Data: {{ usterka.data_zgloszenia }})
                                    </small>
                                </div>

                                <span class="badge
                                    {% if usterka.status == 'oczekuje' %} bg-warning text-dark
                                    {% elif usterka.status == 'w trakcie' %} bg-info text-dark
                                    {% elif usterka.status == 'naprawiona' %} bg-success
                                    {% elif usterka.status == 'odrzucona' %} bg-danger
                                    {% else %} bg-secondary
                                    {% endif %}
                                    ">
                                    {{ usterka.status | capitalize }}
                                </span>
                            </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                        <p class="text-success">Brak zgoszonych usterek dla tego sprztu. </p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-header border-0 p-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <div id="modalCarousel" class="carousel slide" data-bs-interval="false">
                    <div class="carousel-inner">
                        {% if sprzet.zdjecia_lista_url %}
                            {% for url in sprzet.zdjecia_lista_url %}
                                <div class="carousel-item" data-index="{{ loop.index0 }}">
                                    <img src="{{ url }}" class="img-fluid" alt="Powikszone zdjcie {{ loop.index }}">
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="carousel-item active">
                                <img src="{{ url_for('static', filename='img/placeholder.png') }}" class="img-fluid" alt="Brak zdjcia">
                            </div>
                        {% endif %}
                    </div>

                    {% if sprzet.zdjecia_lista_url | length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Poprzednie</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Nastpne</span>
                    </button>
                    {% endif %}
                </div>
                </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ----------------------------------------------------
    // JAWNA INICJALIZACJA GWNEJ KARUZELI (zabezpieczenie)
    // ----------------------------------------------------
    var myCarousel = document.querySelector('#sprzetCarousel');
    if (myCarousel && typeof bootstrap !== 'undefined' && bootstrap.Carousel) {
         new bootstrap.Carousel(myCarousel, {
            interval: false,
            ride: false
        });
    }

    // ----------------------------------------------------
    // INICJALIZACJA I OBSUGA KARUZELI W MODALU (Lightbox)
    // ----------------------------------------------------
    var imageModal = document.getElementById('imageModal');
    var modalCarousel = document.getElementById('modalCarousel');
    var bsModalCarousel = null; // Instancja karuzeli w modalu

    // Jawna inicjalizacja karuzeli w modalu, jeli istnieje
    if (modalCarousel && typeof bootstrap !== 'undefined' && bootstrap.Carousel) {
        bsModalCarousel = new bootstrap.Carousel(modalCarousel, {
            interval: false,
            ride: false
        });
    }

    // Obsuga zdarzenia otwarcia Modala
    imageModal.addEventListener('show.bs.modal', function (event) {
        // Element, kt贸ry wywoa modal (link <a> z karuzeli g贸wnej)
        var triggerLink = event.relatedTarget;

        // Z g贸wnej karuzeli pobieramy URL zdjcia (mo偶na by te偶 pobra index)
        var imageUrl = triggerLink.getAttribute('data-img-url');

        // Znajdowanie wszystkich slajd贸w w karuzeli Modala
        var modalItems = modalCarousel.querySelectorAll('.carousel-item');

        // Iteracja w celu znalezienia slajdu odpowiadajcego kliknitemu zdjciu
        let clickedIndex = 0;
        let found = false;

        // Usuwamy klas 'active' ze wszystkich slajd贸w w modalu na wszelki wypadek
        modalItems.forEach(item => item.classList.remove('active'));

        // Szukanie odpowiedniego slajdu do aktywacji
        for (let i = 0; i < modalItems.length; i++) {
            let itemImg = modalItems[i].querySelector('img');

            if (itemImg.src === imageUrl && !found) {
                modalItems[i].classList.add('active'); // Ustawiamy slajd jako aktywny
                clickedIndex = i;
                found = true;
            }
        }

        // Jeli instancja karuzeli istnieje, ustawiamy j na poprawny slajd
        if (bsModalCarousel) {
             // U偶ycie metody 'to' z instancji karuzeli, aby zresetowa pozycj
             // i upewni si, 偶e nawigacja dziaa poprawnie.
             // U偶ywamy setTimeout, aby upewni si, 偶e modal jest ju偶 w peni wywietlony
             setTimeout(() => {
                 bsModalCarousel.to(clickedIndex);
             }, 50);
        }
    });

    // ----------------------------------------------------
    // OBSUGA MINIATUR GWNEJ KARUZELI (pozostaa bez zmian)
    // ----------------------------------------------------
    document.getElementById('sprzetCarousel').addEventListener('slid.bs.carousel', function (e) {
        const activeIndex = e.to;
        const thumbnails = this.closest('.card').querySelector('.card-footer').querySelectorAll('.img-thumbnail');

        thumbnails.forEach(thumb => thumb.classList.remove('border-primary'));
        if (thumbnails[activeIndex]) {
            thumbnails[activeIndex].classList.add('border-primary');
        }
    });
});
</script>

{% endblock %}
