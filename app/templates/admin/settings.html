{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-lg mt-4">
            <div class="card-header text-bg-primary d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-gear"></i> Ustawienia Aplikacji</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

                    <h5 class="card-title border-bottom pb-2 mb-3">Listy wyboru (konfiguracja)</h5>
                    <p class="text-muted small">Te wartości są używane w formularzach jako wybory/podpowiedzi. Każda pozycja w osobnej linii.</p>

                    <div class="mb-4">
                        <label for="owners" class="form-label fw-bold">Właściciele (owner)</label>
                        <textarea id="owners" name="owners" class="form-control" rows="6" spellcheck="false">{{ (owners or []) | join('\n') }}</textarea>
                        <div class="form-text">Używane przy sprzęcie: Szczep/Leśnicy/…  (pole wymagane dla części kategorii).</div>
                    </div>

                    <div class="mb-4">
                        <label for="magazyny_names" class="form-label fw-bold">Podpowiedzi nazw magazynów</label>
                        <textarea id="magazyny_names" name="magazyny_names" class="form-control" rows="6" spellcheck="false">{{ (magazyny_names or []) | join('\n') }}</textarea>
                        <div class="form-text">Podpowiedzi w formularzach magazynu (np. Esperanto, Obozowa/…).</div>
                    </div>

                     <h5 class="card-title border-bottom pb-2 mb-3">Dostęp przez PIN</h5>
                     <p class="text-muted small">Ustawienia 6-cyfrowego kodu PIN, który umożliwia podgląd kart sprzętu bez pełnego logowania.</p>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Aktualnie obowiązujący PIN:</label>
                        <div class="input-group">
                            <span class="input-group-text text-bg-light"><i class="bi bi-key-fill"></i></span>
                            <input type="password" id="current_pin_val" class="form-control bg-body-tertiary" 
                                   value="{{ config.get('view_pin', '') }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePinView()">
                                <i class="bi bi-eye" id="pin_icon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="view_pin" class="form-label fw-bold">Zmień kod PIN:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                            <input type="text" id="view_pin" name="view_pin" class="form-control" 
                                   placeholder="Wprowadź nowy 6-cyfrowy kod"
                                   pattern="\d{6}" maxlength="6">
                        </div>
                        <div class="form-text">Zostaw puste, aby nie zmieniać. PIN musi składać się z dokładnie 6 cyfr.</div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="pin_auto_rotate" name="pin_auto_rotate"
                                   {% if config.get('pin_auto_rotate') %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="pin_auto_rotate">Automatyczna rotacja kodu PIN</label>
                        </div>
                        <div class="form-text">Jeśli włączone, kod PIN będzie automatycznie zmieniany zgodnie z ustawionym interwałem.</div>
                    </div>
                    
                    <div class="mb-4" id="rotate_hours_container">
                        <label for="pin_rotate_hours" class="form-label fw-bold">Interwał rotacji PIN (w godzinach):</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-clock"></i></span>
                            <input type="number" id="pin_rotate_hours" name="pin_rotate_hours" class="form-control" 
                                   value="{{ config.get('pin_rotate_hours', 24) }}"
                                   min="1" max="720" step="1">
                            <span class="input-group-text">godzin</span>
                        </div>
                        <div class="form-text">Określ co ile godzin PIN będzie automatycznie rotowany (1-720 godzin). Wartość domyślna: 24 godziny.</div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="pin_next_rotate_at" class="form-label fw-bold">Następna automatyczna zmiana PIN (data i godzina):</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                            <input type="datetime-local" id="pin_next_rotate_at" name="pin_next_rotate_at" class="form-control"
                                   step="60"
                                   value="{% if config.get('pin_next_rotate_at') %}{{ config.get('pin_next_rotate_at')[:16] if config.get('pin_next_rotate_at') is string else (config.get('pin_next_rotate_at').strftime('%Y-%m-%dT%H:%M') if hasattr(config.get('pin_next_rotate_at'), 'strftime') else '') }}{% endif %}">
                        </div>
                        <div class="form-text">Opcjonalnie: ustaw konkretną datę/godzinę następnej zmiany PIN. Zostaw puste, aby automat wyliczał termin z interwału.</div>

                        {% if config.get('pin_next_rotate_at') %}
                            <p class="text-muted small mt-2 mb-0">
                                <i class="bi bi-calendar-check"></i> Aktualnie ustawione: <strong>{{ config.get('pin_next_rotate_at') }}</strong>
                            </p>
                        {% endif %}
                    </div>

                    {% if config.get('pin_last_rotate') %}
                    <div class="mb-4">
                        <p class="text-muted small">
                            <i class="bi bi-clock-history"></i> Ostatnia zmiana/rotacja PIN: 
                            <strong>{{ config.get('pin_last_rotate').strftime('%Y-%m-%d %H:%M:%S') if hasattr(config.get('pin_last_rotate'), 'strftime') else config.get('pin_last_rotate') }}</strong>
                        </p>
                    </div>
                    {% endif %}

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save"></i> Zapisz ustawienia
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="{{ url_for('admin.users_list') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Powrót do listy użytkowników
            </a>
        </div>
    </div>
</div>

<script>
function togglePinView() {
    const input = document.getElementById('current_pin_val');
    const icon = document.getElementById('pin_icon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
    }
}
</script>
{% endblock %}
