{% extends 'base.html' %}

{% block content %}
    {% from 'macros.html' import render_field %}

    <style>
        .parent-card-img {
            height: 100%;
            min-height: 150px;
            object-fit: cover;
        }

        .placeholder-dark {
            display: none;
        }

        .placeholder-light {
            display: block;
        }

        html[data-bs-theme="dark"] .placeholder-dark {
            display: block;
        }

        html[data-bs-theme="dark"] .placeholder-light {
            display: none;
        }
    </style>

    <h2 class="mb-4">
        {% if parent_item %}
            {{ parent_item.nazwa or parent_item.id }} - Zawartość
        {% else %}
            Pełny Katalog Sprzętu
        {% endif %}
    </h2>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('views.sprzet_list') }}">Global (Wyszukiwanie)</a></li>
            {% if parent_item %}
                {# Tu można by dodać rekurencyjne breadcrumbs, ale na razie uproszczone #}
                <li class="breadcrumb-item active" aria-current="page">{{ parent_item.id }}</li>
            {% endif %}
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('views.sprzet_list') }}" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Wyszukiwanie Globalne</label>
                    <div class="input-group">
                        <input type="text" name="search" id="search" class="form-control"
                               placeholder="ID, nazwa, typ, uwagi..." value="{{ selected_filters.search or '' }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="category" class="form-label">Kategoria</label>
                    <select name="category" id="category" class="form-select">
                        <option value="">Wszystkie</option>
                        {% for k, v in kategorie.items() %}
                            <option value="{{ v }}"
                                    {% if selected_filters.category == v %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="typ" class="form-label">Typ</label>
                    <select name="typ" id="typ" class="form-select">
                        <option value="">Wszystkie</option>
                        {% for t in typy %}
                            <option value="{{ t }}"
                                    {% if selected_filters.typ == t %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="oficjalna_ewidencja" class="form-label">Oficjalna ewidencja</label>
                    <select name="oficjalna_ewidencja" id="oficjalna_ewidencja" class="form-select">
                        <option value="">Wszystkie</option>
                        <option value="Tak" {% if selected_filters.oficjalna_ewidencja == 'Tak' %}selected{% endif %}>
                            Tak
                        </option>
                        <option value="Nie" {% if selected_filters.oficjalna_ewidencja == 'Nie' %}selected{% endif %}>
                            Nie
                        </option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Filtruj</button>
                    <button type="button" onclick="startScanner()" class="btn btn-outline-primary me-2 d-lg-none">
                        <i class="bi bi-qr-code-scan"></i> Skanuj
                    </button>
                    <a href="{{ url_for('views.sprzet_list') }}" class="btn btn-secondary">Resetuj</a>
                </div>
                <input type="hidden" name="parent_id" value="{{ selected_filters.parent_id or '' }}">
            </form>
        </div>
    </div>

    {% if parent_item %}
        <div class="card mb-4 shadow-sm overflow-hidden">
            <div class="row g-0">
                <div class="col-md-3 col-lg-2">
                    {% if parent_item.zdjecia_lista_url %}
                        <img src="{{ parent_item.zdjecia_lista_url[0] }}"
                             class="img-fluid rounded-start parent-card-img w-100" alt="{{ parent_item.id }}">
                    {% else %}
                        {% set cat = parent_item.category or 'default' %}
                        <img src="{{ url_for('static', filename='assets/img/sprzet/placeholder_' ~ cat ~ '_light.png') }}"
                             onerror="this.src='{{ url_for('static', filename='assets/img/sprzet/placeholder_light.png') }}'"
                             class="img-fluid rounded-start parent-card-img w-100 placeholder-light"
                             alt="Brak zdjęcia">

                        <img src="{{ url_for('static', filename='assets/img/sprzet/placeholder_' ~ cat ~ '_dark.png') }}"
                             onerror="this.src='{{ url_for('static', filename='assets/img/sprzet/placeholder_dark.png') }}'"
                             class="img-fluid rounded-start parent-card-img w-100 placeholder-dark"
                             alt="Brak zdjęcia">
                    {% endif %}
                </div>
                <div class="col-md-9 col-lg-10">
                    <div class="card-body py-2 h-100 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="card-title mb-0 text-primary">
                                    <span class="badge text-bg-primary me-2">{{ parent_item.id | upper }}</span>
                                    {{ parent_item.nazwa or parent_item.typ or (parent_item.category | upper) }}
                                </h5>
                                <small class="text-muted">{{ parent_item.category | upper }}</small>
                            </div>
                            <a href="{{ url_for('views.sprzet_card', sprzet_id=parent_item.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> Pełna karta
                            </a>
                        </div>

                        <div class="row g-2 flex-grow-1">
                            {% if parent_item.category == 'magazyn' %}
                                {{ render_field('GPS Lat', parent_item.gps_lat) }}
                                {{ render_field('GPS Lng', parent_item.gps_lng) }}
                                {% if parent_item.lokalizacja %}
                                    {{ render_field('Lokalizacja', parent_item.lokalizacja) }}
                                {% endif %}
                            {% elif parent_item.category == 'polka_skrzynia' %}
                                {{ render_field('Informacje', parent_item.informacje, is_full=True) }}
                            {% elif parent_item.category == 'namiot' %}
                                {{ render_field('Typ', parent_item.typ) }}
                                {{ render_field('Wodoszczelność', parent_item.wodoszczelnosc) }}
                                {{ render_field('Stan', parent_item.stan_ogolny) }}
                                {{ render_field('Zapałki', parent_item.zapalki) }}
                            {% else %}
                                {% if parent_item.typ %}
                                    {{ render_field('Typ', parent_item.typ) }}
                                {% endif %}
                                {% if parent_item.ilosc %}
                                    {{ render_field('Ilość', (parent_item.ilosc | string) ~ ' ' ~ (parent_item.jednostka or '')) }}
                                {% endif %}
                            {% endif %}

                            {% if parent_item.uwagi %}
                                <div class="col-12 mt-auto">
                                    <div class="bg-body-tertiary p-1 rounded border small">
                                        <span class="text-muted pe-1">Uwagi:</span> {{ parent_item.uwagi | truncate(150) }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="mb-3">
        <div class="dropdown d-inline-block">
            <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                <i class="bi bi-download"></i> Eksportuj
            </button>
            <ul class="dropdown-menu">
                <li>
                    <button class="dropdown-item" onclick="submitExport('csv')">CSV</button>
                </li>
                <li>
                    <button class="dropdown-item" onclick="submitExport('xlsx')">Excel (.xlsx)</button>
                </li>
                <li>
                    <button class="dropdown-item" onclick="submitExport('docx')">Word (.docx)</button>
                </li>
                <li>
                    <button class="dropdown-item" onclick="submitExport('pdf')">PDF</button>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <button class="dropdown-item" onclick="submitExport('qr')"><i class="bi bi-qr-code"></i> Drukuj Kody
                        QR (PDF)
                    </button>
                </li>
            </ul>
        </div>
        <script>
            function submitExport(format) {
                const form = document.createElement('form');
                form.method = 'GET';
                form.action = "{{ url_for('views.export_sprzet', format='FORMAT') }}".replace('FORMAT', format);

                // Kopiuj wszystkie filtry z URL
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.forEach((value, key) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                });

                // Dodaj zaznaczone kolumny z ustawień tabeli
                const config = JSON.parse(localStorage.getItem('szalas_sprzet_cols_v1') || '[]');
                if (config.length > 0) {
                    config.forEach(c => {
                        if (c.visible) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'columns';
                            input.value = c.id;
                            form.appendChild(input);
                        }
                    });
                }

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            }
        </script>
        {% if IS_QUARTERMASTER %}
            <a href="{{ url_for('views.sprzet_add') }}" class="btn btn-outline-primary ms-2">
                <i class="bi bi-plus-circle"></i> Dodaj Sprzęt
            </a>
            <a href="{{ url_for('views.sprzet_import') }}" class="btn btn-outline-info ms-2">
                <i class="bi bi-file-earmark-arrow-up"></i> Importuj
            </a>
        {% endif %}
        <div class="dropdown d-inline-block ms-2">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                <i class="bi bi-layout-three-columns"></i> Kolumny
            </button>
            <ul class="dropdown-menu p-3" id="columnToggleMenu" style="min-width: 250px;">
                <h6 class="dropdown-header px-0">Widoczność i Kolejność</h6>
                <div id="columnSettingsList" class="list-group list-group-flush">
                    {# Generowane dynamicznie przez JS #}
                </div>
                <hr>
                <li>
                    <button class="btn btn-sm btn-outline-secondary w-100" id="resetColumnsBtn">
                        Przywróć domyślne
                    </button>
                </li>
            </ul>
        </div>
    </div>

    {% if sprzet_list %}

        {% if IS_QUARTERMASTER %}
            <div class="mb-2">
                <form id="bulkEditForm" method="POST" action="{{ url_for('views.sprzet_bulk_edit') }}">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                    {# Keep current filters so we can return back to same view after saving #}
                    <input type="hidden" name="return_query" value="{{ request.query_string.decode('utf-8') }}">

                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <button type="submit" class="btn btn-warning" id="bulkEditBtn" disabled>
                            <i class="bi bi-pencil-square"></i> Edytuj zaznaczone
                        </button>
                        <button type="submit" class="btn btn-danger" id="bulkDeleteBtn" disabled
                                formaction="{{ url_for('views.sprzet_bulk_delete') }}"
                                onclick="return confirm('Czy na pewno chcesz usunąć zaznaczone elementy?')">
                            <i class="bi bi-trash"></i> Usuń zaznaczone
                        </button>
                        <span class="text-muted small" id="bulkSelectedInfo">Zaznacz pozycje z listy, aby edytować hurtowo.</span>
                    </div>
                </form>
            </div>
        {% endif %}

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    {% if IS_QUARTERMASTER %}
                        <th style="width: 1%; white-space: nowrap;">
                            <input class="form-check-input" type="checkbox" id="selectAllSprzet"
                                   title="Zaznacz wszystko">
                        </th>
                    {% endif %}
                    <th data-column="id">ID</th>
                    <th data-column="category">Kategoria</th>
                    <th data-column="name">Nazwa / Typ</th>
                    <th data-column="info">Informacje / Stan</th>
                    <th data-column="qty">Ilość</th>
                    <th data-column="unit">Jedn.</th>
                    <th data-column="location">Lokalizacja</th>
                    <th data-column="destination">Przeznaczenie</th>
                    <th data-column="condition">Stan ogólny</th>
                    <th data-column="ewidencja">Ewid.</th>
                    <th>Akcje</th>
                </tr>
                </thead>
                <tbody>
                {% for item in sprzet_list %}
                    <tr id="row-{{ item.id }}">
                        {% if IS_QUARTERMASTER %}
                            <td>
                                {% if not item.is_group %}
                                    <input class="form-check-input sprzet-select" type="checkbox" name="sprzet_ids"
                                           value="{{ item.id }}" form="bulkEditForm">
                                {% endif %}
                            </td>
                        {% endif %}
                        <td class="fw-bold" data-column="id">{{ item.id }}</td>
                        <td data-column="category">
                            <span class="badge text-bg-secondary">{{ item.category|upper }}</span>
                        </td>
                        <td data-column="name">
                            {% if item.category == 'magazyn' %}
                                <i class="bi bi-house"></i>
                            {% elif item.category == 'polka_skrzynia' %}
                                <i class="bi bi-box"></i>
                            {% else %}
                                <i class="bi bi-tools"></i>
                            {% endif %}
                            {% if item.is_group %}
                                <span class="text-primary fw-bold">{{ item.nazwa }}</span>
                                <small class="text-muted">(Suma: {{ item.group_ids|length }})</small>
                            {% else %}
                                {# Dla kanadyjek: jeśli nie ma nazwy, pokaż sam rodzaj (material) zamiast 'Bez nazwy' #}
                                {% if item.category == 'kanadyjki' %}
                                    {% if item.nazwa %}
                                        {% set display_name = item.nazwa %}
                                    {% elif item.typ %}
                                        {% set display_name = item.typ %}
                                    {% elif item.material %}
                                        {% set display_name = item.material %}
                                    {% else %}
                                        {% set display_name = 'Kanadyjka' %}
                                    {% endif %}

                                    {# Jeśli jest nazwa i material, dopisz material w nawiasie #}
                                    {% if item.material and display_name != item.material %}
                                        {% set display_name = display_name ~ ' (' ~ item.material ~ ')' %}
                                    {% endif %}
                                {% else %}
                                    {% set display_name = (item.nazwa or item.typ or 'Bez nazwy') %}
                                {% endif %}

                                {% if item.fast_card and not item.has_children %}
                                    <a href="{{ url_for('views.sprzet_card', sprzet_id=item.id) }}"
                                       class="text-decoration-none">
                                        {{ display_name }}
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('views.sprzet_list', parent_id=item.id) }}"
                                       class="text-decoration-none">
                                        {{ display_name }}
                                    </a>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td data-column="info">
                            {% if item.category == 'magazyn' %}
                                {% if item.gps_lat and item.gps_lng %}
                                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ item.gps_lat }},{{ item.gps_lng }}"
                                       target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-geo-alt"></i> Trasa
                                    </a>
                                {% else %}
                                    Brak współrzędnych
                                {% endif %}
                            {% elif item.category == 'namiot' %}
                                {{ item.wodoszczelnosc or '' }} | {{ item.stan_ogolny or '' }}
                            {% elif item.category == 'przedmiot' %}
                                {{ item.ilosc }} {{ item.jednostka }} |
                                {{ 'Sprawny' if item.sprawny == 'Tak' else 'Niesprawne' }}
                            {% elif item.category == 'kanadyjki' %}
                                {{ item.material or '' }} |
                                {{ 'Sprawna' if item.sprawny == 'Tak' else 'Niesprawna' }}
                            {% else %}
                                {{ item.informacje or item.typ_zelastwa or '' }}
                            {% endif %}

                            {% if not IS_QUARTERMASTER and item.is_loaned %}
                                <br><span class="badge text-bg-danger">Wypożyczone</span>
                            {% endif %}
                        </td>
                        <td data-column="location">
                            {% if item.magazyn_id %}
                                <a href="{{ url_for('views.sprzet_list', parent_id=item.magazyn_id) }}">{{ item.magazyn_display }}</a>
                            {% else %}
                                {{ item.magazyn_display }}
                            {% endif %}
                        </td>
                        <td data-column="qty">{{ item.ilosc if item.ilosc is not none else '' }}</td>
                        <td data-column="unit">{{ item.jednostka or '' }}</td>
                        <td data-column="destination">{{ item.przeznaczenie or '' }}</td>
                        <td data-column="condition">{{ item.stan_ogolny or '' }}</td>
                        <td data-column="ewidencja">
                            {% if item.oficjalna_ewidencja == 'Tak' %}
                                <span class="badge text-bg-success" title="W oficjalnej ewidencji">Tak</span>
                            {% else %}
                                <span class="badge text-bg-secondary" title="Brak w oficjalnej ewidencji">Nie</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                {% if item.is_group %}
                                    {# Dla grupy nie pokazujemy bezpośrednich akcji edycji #}
                                    <span class="badge text-bg-light">Grupowe</span>
                                {% else %}
                                    <a href="{{ url_for('views.sprzet_card', sprzet_id=item.id) }}"
                                       class="btn btn-info btn-sm" title="Karta">
                                        <i class="bi bi-card-list"></i>
                                    </a>
                                    {% if IS_QUARTERMASTER %}
                                        <a href="{{ url_for('views.sprzet_edit', sprzet_id=item.id) }}"
                                           class="btn btn-warning btn-sm" title="Edytuj">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="POST"
                                              action="{{ url_for('views.sprzet_delete', sprzet_id=item.id) }}"
                                              style="display:inline;"
                                              onsubmit="return confirm('Czy na pewno chcesz usunąć ten element?');">
                                            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-danger btn-sm" title="Usuń">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm js-qr-open"
                                            data-qr-id="{{ item.id }}"
                                            title="QR">
                                        <i class="bi bi-qr-code"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        {% if IS_QUARTERMASTER %}
            <script>
                (function () {
                    const selectAll = document.getElementById('selectAllSprzet');
                    const checkboxes = Array.from(document.querySelectorAll('.sprzet-select'));
                    const bulkBtn = document.getElementById('bulkEditBtn');
                    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                    const info = document.getElementById('bulkSelectedInfo');

                    function updateState() {
                        const selected = checkboxes.filter(cb => cb.checked).length;
                        if (bulkBtn) bulkBtn.disabled = selected === 0;
                        if (bulkDeleteBtn) bulkDeleteBtn.disabled = selected === 0;
                        if (info) info.textContent = selected === 0
                            ? 'Zaznacz pozycje z listy, aby edytować hurtowo.'
                            : `Zaznaczone: ${selected}`;

                        if (selectAll) {
                            selectAll.checked = selected > 0 && selected === checkboxes.length;
                            selectAll.indeterminate = selected > 0 && selected < checkboxes.length;
                        }
                    }

                    if (selectAll) {
                        selectAll.addEventListener('change', function () {
                            checkboxes.forEach(cb => cb.checked = selectAll.checked);
                            updateState();
                        });
                    }

                    checkboxes.forEach(cb => cb.addEventListener('change', updateState));
                    updateState();

                    // Column visibility and order logic
                    // Wersjonujemy klucz w localStorage, żeby użytkownikom nie "zniknęły" nowe kolumny przez starą konfigurację.
                    // Aktualna wersja schematu: v3.
                    // Zasada migracji:
                    // - Przy niekompatybilnej zmianie schematu (np. dodanie/usunięcie kolumn, zmiana identyfikatorów)
                    //   zwiększamy sufiks wersji w nazwie klucza (np. sprzet_list_column_config_v4).
                    // - Stare konfiguracje są wtedy ignorowane i traktowane jak brak konfiguracji (używany jest DEFAULT_CONFIG),
                    //   dzięki czemu użytkownik zawsze widzi wszystkie nowe istotne kolumny.
                    // - Jeśli w przyszłości konieczna będzie faktyczna migracja danych, należy ją zaimplementować
                    //   w logice odczytu/zapisu konfiguracji, przed użyciem STORAGE_KEY_CONFIG.
                    const STORAGE_KEY_CONFIG = 'sprzet_list_column_config_v3';
                    const table = document.querySelector('table');
                    const theadRow = table.querySelector('thead tr');
                    const tbody = table.querySelector('tbody');
                    const settingsList = document.getElementById('columnSettingsList');
                    const resetBtn = document.getElementById('resetColumnsBtn');

                    const DEFAULT_CONFIG = [
                        {id: 'id', name: 'ID', visible: true},
                        {id: 'category', name: 'Kategoria', visible: true},
                        {id: 'name', name: 'Nazwa / Typ', visible: true},
                        {id: 'info', name: 'Informacje / Stan', visible: true},
                        {id: 'qty', name: 'Ilość', visible: false},
                        {id: 'unit', name: 'Jedn.', visible: false},
                        {id: 'location', name: 'Lokalizacja', visible: true},
                        {id: 'destination', name: 'Przeznaczenie', visible: false},
                        {id: 'condition', name: 'Stan ogólny', visible: false},
                        {id: 'ewidencja', name: 'Ewid.', visible: false}
                    ];

                    function getConfig() {
                        const saved = localStorage.getItem(STORAGE_KEY_CONFIG);
                        let conf;
                        if (saved) {
                            try {
                                conf = JSON.parse(saved);
                            } catch (e) {
                                conf = null;
                            }
                        }
                        if (!Array.isArray(conf)) {
                            conf = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
                        }

                        // Kompatybilność wstecz: dopisz brakujące kolumny (np. nowo dodana 'ewidencja')
                        const byId = new Set(conf.map(c => c.id));
                        DEFAULT_CONFIG.forEach(c => {
                            if (!byId.has(c.id)) conf.push({id: c.id, name: c.name, visible: c.visible});
                        });

                        return conf;
                    }

                    function saveConfig(config) {
                        localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
                    }

                    function renderSettings() {
                        const config = getConfig();
                        settingsList.innerHTML = '';
                        config.forEach((col, index) => {
                            const item = document.createElement('div');
                            item.className = 'list-group-item d-flex align-items-center justify-content-between p-2';
                            item.innerHTML = `
                        <div class="form-check mb-0">
                            <input class="form-check-input col-visible-toggle" type="checkbox" value="${col.id}" id="chk_${col.id}" ${col.visible ? 'checked' : ''}>
                            <label class="form-check-label small" for="chk_${col.id}">${col.name}</label>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light py-0 move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''}><i class="bi bi-chevron-up"></i></button>
                            <button class="btn btn-sm btn-light py-0 move-down" data-index="${index}" ${index === config.length - 1 ? 'disabled' : ''}><i class="bi bi-chevron-down"></i></button>
                        </div>
                    `;
                            settingsList.appendChild(item);
                        });

                        // Attach events
                        settingsList.querySelectorAll('.col-visible-toggle').forEach(chk => {
                            chk.addEventListener('change', function () {
                                const conf = getConfig();
                                const c = conf.find(x => x.id === this.value);
                                if (c) c.visible = this.checked;
                                saveConfig(conf);
                                applyConfig();
                            });
                        });

                        settingsList.querySelectorAll('.move-up').forEach(btn => {
                            btn.addEventListener('click', function (e) {
                                e.stopPropagation();
                                const idx = parseInt(this.getAttribute('data-index'));
                                const conf = getConfig();
                                [conf[idx], conf[idx - 1]] = [conf[idx - 1], conf[idx]];
                                saveConfig(conf);
                                applyConfig();
                            });
                        });

                        settingsList.querySelectorAll('.move-down').forEach(btn => {
                            btn.addEventListener('click', function (e) {
                                e.stopPropagation();
                                const idx = parseInt(this.getAttribute('data-index'));
                                const conf = getConfig();
                                [conf[idx], conf[idx + 1]] = [conf[idx + 1], conf[idx]];
                                saveConfig(conf);
                                applyConfig();
                            });
                        });
                    }

                    function applyConfig() {
                        const config = getConfig();
                        const ths = Array.from(theadRow.querySelectorAll('th[data-column]'));
                        const staticThsBefore = Array.from(theadRow.querySelectorAll('th')).filter(th => th.querySelector('#selectAllSprzet') || th.cellIndex === 0 && th.querySelector('input'));
                        const staticThsAfter = Array.from(theadRow.querySelectorAll('th')).filter(th => th.textContent.trim() === 'Akcje');

                        const thMap = {};
                        ths.forEach(th => thMap[th.getAttribute('data-column')] = th);

                        // Rebuild Header
                        theadRow.innerHTML = '';
                        staticThsBefore.forEach(th => theadRow.appendChild(th));
                        config.forEach(c => {
                            const th = thMap[c.id];
                            if (th) {
                                th.style.display = c.visible ? '' : 'none';
                                theadRow.appendChild(th);
                            }
                        });
                        staticThsAfter.forEach(th => theadRow.appendChild(th));

                        // Rebuild Body Rows
                        Array.from(tbody.querySelectorAll('tr')).forEach(row => {
                            const tds = Array.from(row.querySelectorAll('td[data-column]'));
                            const staticTdsBefore = Array.from(row.querySelectorAll('td')).filter(td => td.querySelector('.sprzet-select'));
                            const staticTdsAfter = Array.from(row.querySelectorAll('td')).filter(td => (td.querySelector('.btn-group') || td.querySelector('.badge')) && !td.hasAttribute('data-column'));

                            const tdMap = {};
                            tds.forEach(td => tdMap[td.getAttribute('data-column')] = td);

                            row.innerHTML = '';
                            staticTdsBefore.forEach(td => row.appendChild(td));
                            config.forEach(c => {
                                const td = tdMap[c.id];
                                if (td) {
                                    td.style.display = c.visible ? '' : 'none';
                                    row.appendChild(td);
                                }
                            });
                            staticTdsAfter.forEach(td => row.appendChild(td));
                        });

                        renderSettings();
                    }

                    if (resetBtn) {
                        resetBtn.addEventListener('click', function () {
                            localStorage.removeItem(STORAGE_KEY_CONFIG);
                            applyConfig();
                        });
                    }

                    const columnToggleMenu = document.getElementById('columnToggleMenu');
                    if (columnToggleMenu) {
                        columnToggleMenu.addEventListener('click', function (e) {
                            e.stopPropagation();
                        });
                    }

                    applyConfig();
                })();
            </script>
        {% endif %}

        <script>
            (function () {
                function initQrPanel() {
                    try {
                        const overlay = document.getElementById('qrOverlay');
                        if (!overlay) {
                            document.addEventListener('click', function (e) {
                                const btn = e.target && e.target.closest ? e.target.closest('.js-qr-open') : null;
                                if (btn) {
                                    e.preventDefault();
                                    alert('Błąd: Panel QR nie został załadowany. Skontaktuj się z administratorem.');
                                }
                            });
                            return;
                        }

                        const idEl = document.getElementById('qrPanelId');
                        const imgEl = document.getElementById('qrPanelImg');
                        const errEl = document.getElementById('qrPanelError');
                        const cardLink = document.getElementById('qrPanelCardLink');
                        const dlLink = document.getElementById('qrPanelDownloadLink');
                        const targetUrlEl = document.getElementById('qrPanelTargetUrl');

                        // NEW: base URL provided by backend as a constant (e.g. "https://200wdhigz.github.io")
                        const QR_BASE_URL = {{ (qr_url or '') | tojson }};

                        function openOverlay() {
                            overlay.hidden = false;
                            document.body.style.overflow = 'hidden';
                        }

                        function closeOverlay() {
                            overlay.hidden = true;
                            document.body.style.overflow = '';
                            if (imgEl) imgEl.removeAttribute('src');
                            if (errEl) {
                                errEl.classList.add('d-none');
                                errEl.textContent = '';
                            }
                        }

                        function setError(msg) {
                            if (!errEl) return;
                            errEl.textContent = msg;
                            errEl.classList.remove('d-none');
                        }

                        function joinUrl(base, path) {
                            const b = String(base || '').replace(/\/+$/, '');
                            const p = String(path || '').replace(/^\/+/, '');
                            return b ? (b + '/' + p) : ('/' + p);
                        }

                        function loadForId(sprzetId) {
                            if (!sprzetId) return;
                            if (idEl) idEl.textContent = sprzetId;

                            const cardPath = '/sprzet/' + encodeURIComponent(sprzetId);
                            const cardAbsUrl = joinUrl(QR_BASE_URL, cardPath);

                            if (cardLink) cardLink.href = cardAbsUrl;

                            // Target link under QR uses QR_BASE_URL (not window.location.origin)
                            if (targetUrlEl) {
                                targetUrlEl.href = cardAbsUrl;
                                targetUrlEl.textContent = cardAbsUrl;
                            }

                            const qrUrl = '/sprzet/' + encodeURIComponent(sprzetId) + '/qrcode';
                            if (dlLink) dlLink.href = qrUrl + '?download=1';

                            if (errEl) {
                                errEl.classList.add('d-none');
                                errEl.textContent = '';
                            }

                            if (!imgEl) {
                                setError('Błąd UI: brak elementu img dla QR.');
                                return;
                            }

                            imgEl.onload = function () {
                                if (errEl) {
                                    errEl.classList.add('d-none');
                                    errEl.textContent = '';
                                }
                            };
                            imgEl.onerror = function () {
                                setError('Nie udało się wygenerować QR dla tego elementu.');
                            };
                            imgEl.src = qrUrl + '?v=' + Date.now();
                        }

                        document.addEventListener('click', function (e) {
                            const btn = e.target && e.target.closest ? e.target.closest('.js-qr-open') : null;
                            if (btn) {
                                e.preventDefault();
                                openOverlay();
                                loadForId(btn.getAttribute('data-qr-id'));
                                return;
                            }

                            const closeEl = e.target && e.target.getAttribute ? (e.target.getAttribute('data-qr-close') || '') : '';
                            if (closeEl === '1') {
                                e.preventDefault();
                                closeOverlay();
                            }
                        });

                        const directButtons = Array.prototype.slice.call(document.querySelectorAll('.js-qr-open'));
                        directButtons.forEach(function (btn) {
                            btn.addEventListener('click', function (e) {
                                e.preventDefault();
                                openOverlay();
                                loadForId(btn.getAttribute('data-qr-id'));
                            });
                        });

                        document.addEventListener('keydown', function (e) {
                            if (e.key === 'Escape' && overlay && !overlay.hidden) {
                                closeOverlay();
                            }
                        });
                    } catch (err) {
                        console.error('QR panel init error', err);
                        alert('Błąd JS panelu QR: ' + (err && err.message ? err.message : String(err)));
                    }
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initQrPanel);
                } else {
                    initQrPanel();
                }
            })();
        </script>

    {% else %}
        <p>Brak sprzętu do wyświetlenia. Skontaktuj się z administratorem.</p>
    {% endif %}

    {# Panel QR (bez Bootstrap modal – własny overlay) #}
    <div id="qrOverlay" class="qr-overlay" hidden>
        <div class="qr-backdrop" data-qr-close="1"></div>
        <div class="qr-panel" role="dialog" aria-label="QR kod">
            <div class="qr-header">
                <div>
                    <strong>QR:</strong> <span id="qrPanelId" class="qr-mono"></span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-qr-close="1">Zamknij</button>
            </div>

            <div class="qr-body">
                <div id="qrPanelError" class="alert alert-warning d-none" role="alert"></div>
                <img id="qrPanelImg" alt="QR" class="qr-img"/>

                <!-- Docelowy link pod QR (kopiowalny) -->
                <div class="small mt-2">
                    <div class="text-muted">Link docelowy:</div>
                    <a id="qrPanelTargetUrl" class="qr-mono" href="#" target="_blank" rel="noopener"></a>
                </div>

                <div class="qr-actions">
                    <a id="qrPanelCardLink" class="btn btn-primary" href="#">Otwórz kartę</a>
                    <a id="qrPanelDownloadLink" class="btn btn-success" href="#" download>Pobierz PNG</a>
                </div>
            </div>
        </div>
    </div>

    <style>
        .qr-overlay[hidden] {
            display: none !important;
        }

        .qr-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
        }

        .qr-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .45);
        }

        .qr-panel {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: min(520px, calc(100vw - 32px));
            max-height: calc(100vh - 32px);
            overflow: auto;
            background: var(--bs-body-bg, #fff);
            color: var(--bs-body-color, #111);
            border: 1px solid rgba(0, 0, 0, .15);
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, .25);
        }

        .qr-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 12px;
            border-bottom: 1px solid rgba(0, 0, 0, .1);
        }

        .qr-body {
            padding: 12px;
            text-align: center;
        }

        .qr-img {
            width: 100%;
            max-width: 420px;
            height: auto;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, .12);
            border-radius: 10px;
            padding: 10px;
        }

        .qr-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .qr-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
        }
    </style>
{% endblock %}
