{% extends 'base.html' %}

{% block content %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{% if show_history %}Historia Wypożyczeń{% else %}Aktywne Wypożyczenia{% endif %}</h2>
            <div>
                {% if show_history %}
                    <a href="{{ url_for('views.loans_list') }}" class="btn btn-outline-primary">Pokaż tylko aktywne</a>
                {% else %}
                    <a href="{{ url_for('views.loans_list', history=1) }}" class="btn btn-outline-secondary">Pokaż historię</a>
                {% endif %}
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Przedmiot</th>
                    <th>Przez kogo</th>
                    <th>Kontakt</th>
                    <th>Do kiedy</th>
                    <th>Ewid.</th>
                    <th>Status</th>
                    <th>Akcje</th>
                </tr>
                </thead>
                <tbody>
                {% for loan in loans %}
                    <tr {% if loan.status == 'returned' %}class="table-secondary text-muted"{% endif %}>
                        <td>
                            <a href="{{ url_for('views.sprzet_card', sprzet_id=loan.item_id) }}">
                                [{{ loan.item.id }}] {{ loan.item.nazwa or loan.item.typ or '' }}
                            </a>
                        </td>
                        <td>{{ loan.przez_kogo }}</td>
                        <td>{{ loan.kontakt or 'N/A' }}</td>
                        <td>{{ loan.do_kiedy or 'N/A' }}</td>
                        <td>
                            {% if loan.item and loan.item.oficjalna_ewidencja == 'Tak' %}
                                <span class="badge text-bg-success" title="W oficjalnej ewidencji">Tak</span>
                            {% else %}
                                <span class="badge border text-body-secondary" title="Brak w oficjalnej ewidencji">Nie</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if loan.status == 'active' %}
                                <span class="badge bg-success">Aktywne</span>
                            {% else %}
                                <span class="badge bg-secondary">Zwrócone</span>
                                <div class="small">Data zwrotu: {{ loan.return_timestamp }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if loan.status == 'active' %}
                                <form method="POST" action="{{ url_for('views.loan_return', loan_id=loan.id) }}"
                                      style="display:inline;"
                                      onsubmit="return confirm('Czy na pewno chcesz oznaczyć jako zwrócone?');">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-success btn-sm">Zwróć</button>
                                </form>
                            {% else %}
                                {% if session.get('user_role') == 'admin' %}
                                    <form method="POST" action="{{ url_for('views.loan_delete', loan_id=loan.id, history=1) }}"
                                          style="display:inline;"
                                          onsubmit="return confirm('Usunąć historyczne wypożyczenie? Tej operacji nie da się cofnąć.');">
                                        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Usuń</button>
                                    </form>
                                {% else %}
                                    -
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not loans %}
            <p>Brak wypożyczeń do wyświetlenia.</p>
        {% endif %}
    </div>
{% endblock %}
